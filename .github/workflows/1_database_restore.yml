name: Restore Azure PostgreSQL

on:
  workflow_dispatch:  # Allows manual trigger
    inputs:
      resource_group:
        description: "Azure Resource Group"
        required: true
        default: "NetworkWatcherRG"
      source_server:
        description: "Source PostgreSQL Server Name"
        required: true
        default: "labaitest"
      new_server:
        description: "New Restored Server Name"
        required: true
        default: "labaitest-restored"

jobs:
  restore_pgsql:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          client-secret: ${{ secrets.AZURE_CLIENT_SECRET }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}


      - name: Fetch Latest Backup Time
        id: get_backup_time
        run: |
          LATEST_RESTORE_TIME=$(az postgres flexible-server show \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name ${{ github.event.inputs.source_server }} \
            --query "earliestRestoreDate" --output tsv)

          if [[ -z "$LATEST_RESTORE_TIME" ]]; then
            echo "❌ ERROR: Unable to retrieve the latest backup time. Exiting..."
            exit 1
          fi

          echo "Latest Backup Time: $LATEST_RESTORE_TIME"
          echo "RESTORE_TIME=$LATEST_RESTORE_TIME" >> $GITHUB_ENV

      - name: Restore PostgreSQL Server
        run: |
          az postgres flexible-server restore \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --name ${{ github.event.inputs.new_server }} \
            --source-server ${{ github.event.inputs.source_server }} \
            --restore-time "$RESTORE_TIME"

      - name: Completion Message
        run: echo "✅ PostgreSQL Restore Completed Successfully!"
